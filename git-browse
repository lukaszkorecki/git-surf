#!/usr/bin/env bash
set -e
# utility / setup functions
logerr() { echo "$@" 1>&2; }

GIT_BROWSE_VERSION=0.3.1

# detect open-url command
(  uname | grep Darwin >/dev/null ) && ( which open 2>&1 > /dev/null ) &&  open_command='open'
(  uname | grep Linux >/dev/null ) && (which xdg-open 2>&1 > /dev/null) && open_command='xdg-open'

if [[ -z "$open_command" ]] ; then
  logerr 'No command to open the url in the browser!'
fi

showHelp() {
  cat <<-HELP_MSG
Usage: `basename $0` [OPTION] [FILE or COMMIT SHA1]
Quick and dirty tool for browsing files, commits and pull requests on GitHub
Example: git browse -r10,30 git-browse

Will open default web browser pointing to the git-browse file on GitHub with
lines 10 to 30 highlighted. If a tool like open (OSX) or xdg-open (Linux) is
not available, the following url will be printed to STDOUT

https://github.com/lukaszkorecki/git-browse/tree/master/git-browse#L10-L30

Options:

-r - range of lines to highlight can be single line, or a range of lines, comma
		separated (10,30)
-c - opens specified commit
-R - specifies different remote than origin
-p - opens a pull requests for current branch
HELP_MSG
}

# get current branch for given repo
currentBranch() {
  git rev-parse --abbrev-ref HEAD
}

# urlencode function taken from http://stackoverflow.com/a/17989856/130896
urlSafeCurrentBranch() {
  currentBranch | urlEncode
}
urlEncode() {
  od -An -tx1 | tr ' ' % | xargs printf "%s"
}

# parse out a path to a file and/or repo
# first arg is the path to the file, falls back to repo root
getRepoRoot() {
  # git rev-parse --show-toplevel
  if [[ -z "$1" || "$1" == "." ]] ; then
    echo ""
  else
    git ls-tree $(currentBranch) --full-name $1 | awk '{ print $4 }'
  fi
}


# FIXME needs to handle more
# first arg is the remote name, falls back to 'origin'
# Example:
#   git@github.com:lukaszkorecki/git-browse.git (fetch)
#   ->
#   lukaszkorecki/git-browse
gitRepoUrl() {
  local remote_url=$(git remote -v | grep -m1 $1 |  awk '{ print $2 }'  )
  # 1st sed removes git@github.com/, https://github.com/ and
  # git@github.com:
  local user_and_repo_name=$(echo $remote_url | sed -e 's/.*github.com.//' -e 's/.git$//' )
  if [[ -z $user_and_repo_name ]] ; then
    logerr "Remote named '$1' was not found!"
    exit 1
  fi

  local part=$2
  [[ -z "$part" ]] && part="tree"
  local branch=""
  [[ -z "$3" ]] && branch=$(currentBranch)
  [[ -n "$3" ]] && branch=$(urlSafeCurrentBranch)
  echo "https://github.com/$user_and_repo_name/$part/$branch"
}

# FIXME github only
# turns https://github.com/a/b/tree/master into https://github.com/a/b/commit/SHA
getCommitUrl() {
  if [[ -z "$1" ]] ; then
    logerr 'No commit SHA1!'
    exit 1
  fi
  echo $(gitRepoUrl $REMOTE "commit" | sed "s/$(currentBranch)/$1/")
}

getCompareURL() {
  if [[ -z "$1" ]] ; then
    logerr "No branch to compare!"
    exit 1
  fi
  local compareBranch=$(gitRepoUrl $REMOTE  "compare" 1 )
  echo "$compareBranch...$(urlSafeCurrentBranch "$1")"

}

getPullReqUrl() {
  echo $(gitRepoUrl $REMOTE "pull" 1 )
}

# turns 20,30 into #L20-L30
parseRange() {
  if [[ -z "$1" ]] ; then
    echo ""
  else
    echo "#L$(echo "$1" | sed 's/\,/-L/')"
  fi
}

# Start actuall prog

REMOTE=origin
SHOWHELP=n
SHOWCOMMIT=n
SHOWCOMPARE=n
COMPAREBRANCH=master
RANGE=""
# TODO
SHOWPULLREQUEST=n

while getopts "hC:c:R:r:pn" OPTIONS; do
  case "$OPTIONS" in
    h)
      SHOWHELP=y
      ;;

    c)
      SHOWCOMMIT=y
      COMMIT="$OPTARG"
      ;;

    C)
      SHOWCOMPARE=y
      COMPAREBRANCH="$OPTARG"
      ;;

    R)
      REMOTE="$OPTARG"
      ;;

    r)
      RANGE="$OPTARG"
      ;;
    p)
      SHOWPULLREQUEST=y
      ;;
    n)
      NOOPEN=y
      ;;
  esac
done

# last unparsed arg becomes the file
FILE=$(echo "$*" | awk '{ print $NF }')

if [[ $SHOWHELP == 'y' ]] ; then
	showHelp
  exit 0
fi
# commit mode
if [[ $SHOWCOMMIT == 'y' ]] ; then
  url=$(getCommitUrl $COMMIT)
elif [[ $SHOWCOMPARE == 'y' ]] ; then
  url=$(getCompareURL $COMPAREBRANCH)
elif [[ $SHOWPULLREQUEST == 'y' ]] ; then
  url=$(getPullReqUrl)
else
  range=$(parseRange $RANGE)
  path=$(getRepoRoot $FILE)
  url="$(gitRepoUrl $REMOTE)/$path$range"

fi

if [[ "$NOOPEN" = "y" ]] ;then
  echo $url
else
  if [[ -z $DEBUG ]] ; then
    if [[ -z "$open_command" ]] ; then
      echo $url
    else
      eval "$open_command '$url'"
    fi
  else
    logerr "Open command: $open_command"
    logerr "Url: $url"
  fi
fi
